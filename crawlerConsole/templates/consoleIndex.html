<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8">
    <meta name="renderer" content="webkit">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="author" content="hechanglin.cn">
    <link rel="icon" href="favicon.ico">
    <title>爬虫运行管理</title>
    <link href="/static/css/bootstrap.min.css" rel="stylesheet">
    <script src="/static/js/jquery.min.js"></script>
</head>

<body>
    <style>
        * {
            transition: all 0.5s ease;
        }

        html,
        body {
            height: 100%;
            padding-top: 25px;
            min-width: 300px;
            /*background: #fff;*/
        }

        #out-container {
            height: 100%;
            overflow: auto;
            padding-top: 50px;
        }
        /*自定义导航栏*/

        .hcl-nav {
            height: 50px;
            padding: 5px 20px;
            background: #fff;
            position: absolute;
            width: 100%;
            z-index: 7;
            top: 0;
            left: 0;
            transition: all 2s ease;
        }

        .hcl-nav a {
            text-decoration: none;
        }

        .hcl-nav .logo {
            display: inline;
        }

        .hcl-nav .logo img {
            height: 25px;
            width: auto;
            margin: 5px;
        }

        .hcl-nav .logo a {
            font-size: 18px;
            line-height: 40px;
            color: #999;
        }

        .hcl-nav .logo a:hover {
            color: #666;
        }

        .hcl-nav-link {
            float: right;
            font-size: 16px;
            line-height: 40px;
            color: #c00;
        }

        .hcl-nav-link:hover {
            color: #900;
        }
        /*user资料卡片*/

        #user-inf-card {
            padding: 15px;
            text-align: center;
            background: #fefefe;
        }

        #user-inf-card img {
            height: 80px;
            border-radius: 50%;
            border: #999 1px solid;
            box-shadow: 0 0 3px #000;
            vertical-align: middle;
        }

        #user-inf-card div {
            display: inline-block;
            vertical-align: middle;
            padding: 15px;
        }
        /*页面主体*/

        #main-html {
            padding-top: 10px;
        }

        #main-html .hcl-title {
            padding-left: 1em;
            margin-top: 15px;
            margin-bottom: 15px;
        }
        /*基础链接样式*/

        .hcl-link {
            font-size: 16px;
            padding: 0.6em 0.4em;
            color: #369;
            cursor: pointer;
        }

        .hcl-link:hover {
            color: #08c;
        }
        #table td {
            white-space: normal;
        }
    </style>
    <div class="hcl-nav">
        <div class="logo">
            <a href="#">品牌分析爬虫管理</a>
        </div>
    </div>
    <br>
    <div class="container center">
        <h3>爬虫运行情况</h3><br>
        <table id="table" class="display cell-border" width="100%"></table>
    </div>

    <div class="modal" id="evaluatedModal2" tabindex="-1" role="dialog" aria-labelledby="evaluatedModal2Label">
        <div class="modal-dialog " role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="evaluatedModal2Label">爬虫日志</h4>
{#                    <input id="spider" hidden></input>#}
                </div>
                <div class="modal-body">
                    <table id="table2" class="display cell-border" width="100%"></table>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
                </div>
            </div>
            </div>
        </div>
    </div>


    <br><br>
<script src="/static/js/bootstrap.min.js"></script>
<link rel="stylesheet" type="text/css" href="/static/css/jquery.dataTables.min.css">
<script type="text/javascript" charset="utf8" src="/static/js/jquery.dataTables.min.js"></script>
<script>
      //dataTable 默认配置(汉化)
    $.extend( $.fn.dataTable.defaults, {
        "bProcessing": false,//开启读取服务器数据时显示正在加载中
        "bStateSave": true,//是否开启状态保存，当选项开启的时候会使用一个cookie保存表格展示的信息的状态
        "bPaginate": false,//启用或禁用分页功能
        "bAutoWidth": true,//启用或禁用自动列宽度的计算。
        "bPaginate": true,//启用或禁用分页功能
        "deferRender": true,//当处理大数据时，延迟渲染数据，有效提高Datatables处理能力
        "language": {
        "sProcessing": "处理中...",
        "sLengthMenu": "每页显示 _MENU_ 项结果",
        "sZeroRecords": "没有匹配结果",
        "sInfo": "显示第 _START_ 至 _END_ 项结果，共 _TOTAL_ 项",
        "sInfoEmpty": "显示第 0 至 0 项结果，共 0 项",
        "sInfoFiltered": "(由 _MAX_ 项结果过滤)",
        "sInfoPostFix": "",
        "sSearch": "在结果中查找:",
        "sUrl": "",
        "sEmptyTable": "表中数据为空",
        "sLoadingRecords": "载入中...",
        "sInfoThousands": ",",
        "oPaginate": {
            "sFirst": "首页",
            "sPrevious": "上页",
            "sNext": "下页",
            "sLast": "末页"
        },
        "oAria": {
            "sSortAscending": ": 以升序排列此列",
            "sSortDescending": ": 以降序排列此列"
        }
        }
    });

    var table=$('#table').DataTable({
        "bStateSave": false,
        "lengthMenu": [[-1], ["全部"]],
        "ajax": {
        "url": "get_spider_status.php",
        "type": "post",
        "data": function ( d ) {
            d.menu = "get_status";
            d.method = "read";
        },
{#        "error":function(){alert("服务器未正常响应，请重试");},#}
        },
        "columns": [
            { "data": "process_name", "title":"进程检测标识","defaultContent":""},
            { "data": "name", "title":"爬虫","defaultContent":""},
            { "data": "host", "title":"主机","defaultContent":""},
            { "data": "python_version", "title":"python版本","defaultContent":""},
	        { "data": "status", "title":"运行状况","defaultContent":"","width":"130px"},
            { "data": "log", "title":"日志","defaultContent":"<button class='btn btn-sm btn-info log-btn'><i class='fa fa-search fa-fw'></i> 查看</button>","width":"130px"},
            { "data": "control", "title":"操作","defaultContent":"<button class='btn btn-sm btn-info start-spider'><i class='fa fa-search fa-fw'></i> 启动</button>  <button class='btn btn-sm btn-info stop-spider'><i class='fa fa-search fa-fw'></i> 停止</button>","width":"130px"},
            { "data": "path", "title":"路径","defaultContent":"","visible":false},
        ],
        "createdRow": function ( row, data, index ) {
            $(row).children()[2].innerHTML=data['host']+"("+data['path']+")";
        },
        "order": [[ 0, "asc" ]],
    });

    var table2=$('#table2').DataTable({
        "bStateSave": false,
        "lengthMenu": [[10,-1], ["10","全部"]],
        "ajax": {
        "url": "get_spider_log.php",
        "type": "post",
        "data": function ( d ) {
            d.spider = $('#spider').val();
        },
{#        "error":function(){alert("服务器未正常响应，请重试");},#}
        },
        "columns": [
            { "data": "time", "title":"时间","defaultContent":"","width":"140px"},
            { "data": "content", "title":"内容","defaultContent":""},
        ],
        "createdRow": function ( row, data, index ) {

        },
        "order": [[ 0, "desc" ]],
    });

    $("#table tbody").on("click",".start-spider",function(){
        var command=prompt("输入爬虫启动参数","");
        if (command==null){
            return false;
        }
        var row = table.row($(this).parents("tr"));
        var data= row.data();
        /*var postData={
            "action":"start",
            "spider":data['process_name'],
            "command":command,
        }*/
        data['action']="start";
        data['command']=command;
        $.ajax({
            "url":"spider_controller.php",
            "data":data,
            "type":"post",
            "success":function(response){
                alert(response);
            }
        })
    });

    $("#table tbody").on("click",".stop-spider",function(){
        var row = table.row($(this).parents("tr"));
        var data= row.data();
        /*var postData={
            "action":"stop",
            "spider":data['process_name'],
        }*/
        data['action']="stop";
        data['command']="";
        $.ajax({
            "url":"spider_controller.php",
            "data":data,
            "type":"post",
            "success":function(response){
                alert(response);
            }
        })
    });

    $("#table tbody").on("click",".log-btn",function(){
        var row = table.row($(this).parents("tr"));
        var data= row.data();
        $('#spider').val(data['process_name']);
        $('#evaluatedModal2').modal();
        table2.ajax.reload();
    });

    function table_reflush(){
        table.ajax.reload();
        table2.ajax.reload();
    }

    var init = setInterval(table_reflush, 2000);



</script>

</body>